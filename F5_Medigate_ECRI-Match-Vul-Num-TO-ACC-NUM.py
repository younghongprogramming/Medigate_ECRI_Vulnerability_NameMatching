import pandas as pd
import openpyxl
import os

medigate_excel_path = '/Users/younghong/Documents/Files/Medigate - Vulnerabilities (Remediable_Medical_Vulnerabilities View) - PHSA - 2023-05-02.xlsx'
ecri_vul_name_path = '/Users/younghong/Documents/Files/ECRI_Associated_Vul_Name.xlsx'

df1 = pd.read_excel(medigate_excel_path, usecols='b,d')
vul_name_medigate = pd.read_excel(medigate_excel_path, usecols='b')
cves_medgiate = pd.read_excel(medigate_excel_path, usecols='c')

df2 = pd.read_excel(ecri_vul_name_path)
acc_num = pd.read_excel(ecri_vul_name_path, usecols='b')

## data to list ##
list_df1 = df1.values.tolist()
list_vul_name_medigate = vul_name_medigate.values.tolist()
list_cves_medigate = cves_medgiate.values.tolist()

#print(list_df1)

list_df2 = df2.values.tolist()
list_acc_num = acc_num.values.tolist()


## filtering process to get rid of 'none' value in excel data ##
filtered_df2 = []
for dataframe in list_df2:
    filtered_data = []
    for data in dataframe:
        if 'nan' in str(data):
            pass
        else:
            filtered_data.append(data)
    filtered_df2.append(filtered_data)

## matching process ##
i=0
new_vul_name_med_ecri = []
for dataframe_ecri in filtered_df2:
    i=i+1
    for data_ecri in dataframe_ecri:
        j=0
        for dataframe_medigate in list_df1:
            j=j+1
            if data_ecri in dataframe_medigate:
                #print(dataframe_ecri)
                #print(dataframe_medigate)
                #print(list_acc_num[i-1])
                #print(list_vul_name_medigate[j-1])
                list_vul_name_medigate[j-1].extend(list_acc_num[i-1])

            else:
                pass

# Get rid of repeated data
unique_vul_name_medigate = []

for old_list in list_vul_name_medigate:
    new_list = []
    for data in old_list:
        if data not in new_list:
            new_list.append(data)
    unique_vul_name_medigate.append(new_list)

print(unique_vul_name_medigate)

## finding max column size ##
previous_length = 0
max_length = 0
for list in unique_vul_name_medigate:
    current_length = (len(list))
    if current_length > max_length:
        max_length = current_length
        previous_length = current_length
    else:
        previous_length = current_length


## column names ##
col = ['vul_name']
for i in range(1,max_length):
    col_name = f'ECRI_Acc_Num_{i}'
    col.append(col_name)

#print(col)

## new dataframe ##


new_df = pd.DataFrame(data = unique_vul_name_medigate, columns= col)
#print("from here")
#print(new_df)


save_path = '/Users/younghong/Documents/Files/Matching_Data_Medigate_ECRI.xlsx'
new_df.to_excel(save_path)

